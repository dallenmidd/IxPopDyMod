---
title: "The `IxPopDyMod` package for writing and analyzing tick population dynamics models"
output: github_document
---

# Purpose

This package is designed to help users easily write, analyze, and compare tick population dynamics models. There is a long history of using these models to better understand the drivers of tick populations and predict how tick populations could respond to climate change, different host community composition, or tick control strategies. I hope that this package will make it easier for these models to be used.

# Examples of package use

This vignette presents three examples of package use. The hope is that this will help others see how models are specified and better understand the structure of the package. The examples highlight:

1. How tick transitions can be temperature-dependent
1. How to incorporate the host community into a model
1. How to include tick-borne disease infection dynamics into a model

First load the package and tidyverse

```{r}
library(IxPopDyMod)
library(tidyverse)
```

## Temperature-dependent transitions

The first step is always to read a `config` file. This is the configuration which specifies the model. Here I read the `config` and then show the tick life-stage transitions.

```{r}
cfg <- read_config('temp_example_config/config.yml')
cfg$transitions
```

From the first line, you see that the development from eggs, `__e`, to questing larvae, `q_l`, is an exponential function of temperature. We can see the parameters for this transition:

```{r}
cfg$parameters %>% filter(from == '__e', to == 'q_l')
```

The daily development rate is 0.0000292*temp^2.27.

### Compare two temperature scenarios

Here I highlight how this temperature dependence affects the output of the model. I make a second `config` in which the daily temperature is one degree warmer.

```{r}

cfg2 <- cfg
cfg2$weather <- cfg$weather %>% mutate(tmean = tmean + 1)

output1 <- run(cfg)
output2 <- run(cfg2)

output1 <- output1 %>% mutate(temp = 'cold')
output2 <- output2 %>% mutate(temp = 'warm')
```

Finally I compare the outputs for a commonly measured aspect of tick populations, the number of questing nymphs. 

```{r}
output1 %>%
  rbind(output2) %>% 
  filter(stage == 'q_n') %>%
  ggplot(aes(day, pop, col = temp)) +
  geom_line() +
  scale_color_manual(values = c('cold' = 'blue', 'warm' = 'red')) +
  ylab('Questing nymphs')
```

Here you can see nymphs start questing earlier and reach a higher population in the warmer climate. 

## Host community

In the previous example there was no host community explicitly stated and ticks had a constant probabilty of transition between life stages (e.g., from larva to nymph). It is possible to instead model these probabilities based on host community composition. 

```{r}
cfg <- read_config('host_example_config/config.yml')
cfg$transitions
```

Here transition from questing larvae, `q_l`, to engroged larvae, `e_l`, depends on the `host_den`, this is how the host community is included in the transition. 

```{r}
cfg$parameters %>% filter(from == 'q.l', to == 'e.l')

```
Here the parameters of `find_n_feed` get different values for each host species. In this case the two parameters are `pref`, which is the larval tick's preference for the three different host species, and `feed_success`, which is the fraction of feeding larvae which successfully feed to completion. 

In this example the temperature and host community are constant through time, but this case change to see how seasonal or year-to-year variation in host density affects tick populations.

### Compare host communities of different densities

I now compare how different host densities affect tick populations. Here I vary the deer density.

```{r, results = 'hide'}
cfg_lowdeerden <- cfg
cfg_highdeerden <- cfg
cfg_lowdeerden$host_comm <- cfg$host_comm %>% 
  mutate(host_den = ifelse(host_spp == 'deer', 0.1, host_den) )

cfg_highdeerden$host_comm <- cfg$host_comm %>% 
  mutate(host_den = ifelse(host_spp == 'deer', 5, host_den) )


output_middeerden <- run(cfg)
output_lowdeerden <- run(cfg_lowdeerden)
output_highdeerden <- run(cfg_highdeerden)

output_middeerden <- output_middeerden %>% mutate(deer_den = 'mid')
output_lowdeerden <- output_lowdeerden %>% mutate(deer_den = 'low')
output_highdeerden <- output_highdeerden %>% mutate(deer_den = 'high')
```

And then use the `graph_population_each_group` function to see how the deer densities affect the tick population.

```{r}
output_lowdeerden %>%
  bind_rows(output_middeerden, output_highdeerden) %>%
  mutate(deer_den = factor(deer_den, levels = c('low', 'mid', 'high'))) %>%
  graph_population_each_group() +
  facet_wrap(~deer_den)

```

## Tick-borne disease infection dynamics

In the examples above I modeled just a tick population without a tick borne disease. Here I give an example of how the package can be used to also include 
